Open the all the raw counts data

```{r}
rawdata <- read.csv("raw.data.PN5-PN60.with.ips.and.diff.csv")

#read the sample info
info <- read.csv("info_all.csv")
```

Data arrangement

```{r}
#select out the read data

data <- rawdata[,-1]
#data <- data[,-(19:20)]

#save name of rows to names of gene list
rownames(data) <- make.names(rawdata[,1], unique = TRUE)
```

DESeq part

```{r}
#prepare data for DESeq2
dds <- DESeqDataSetFromMatrix(data,
                              colData = info,
                              design = ~Type)


#filter out low counts genes
keep <- rowSums(counts(dds)) >= 10

#apply the "keep" condition on the dds
dds <- dds[keep,]

#main DESeq
ddsDE <- DESeq(dds)

#normalize the read counts
normCounts <- counts(ddsDE, normalized = T)

#save the csv file of the normalized data
#write.csv(normCounts, "normalized.data.231214.csv")

```

```{r}
#DESeq results
res1 <- results(ddsDE, contrast=c("Type","Early","Late"), alpha = 0.05)
res2 <- results(ddsDE, contrast=c("Type","Early","Mid"), alpha = 0.05)
res3 <- results(ddsDE, contrast=c("Type","Late","Mid"), alpha = 0.05)
res4 <- results(ddsDE, contrast=c("Type","Early","Control"), alpha = 0.05)
res5 <- results(ddsDE, contrast=c("Type","Late","Control"), alpha = 0.05)
res6 <- results(ddsDE, contrast=c("Type","Mid","Control"), alpha = 0.05)


```

reorder the results data and save the csv files

```{r}
#reorder res

resOrdered1 <- res1[order(res1$padj),]
resOrdered2 <- res2[order(res2$padj),]
resOrdered3 <- res3[order(res3$padj),]
resOrdered4 <- res4[order(res4$padj),]
resOrdered5 <- res5[order(res5$padj),]
resOrdered6 <- res6[order(res6$padj),]

write.csv(resOrdered1, "230314.deseq.res1.Early.vs.Late.csv")
write.csv(resOrdered2, "230314.deseq.res2.Early.vs.Mid.csv")
write.csv(resOrdered3, "230314.deseq.res3.Late.vs.Mid.csv")
write.csv(resOrdered4, "230314.deseq.res4.Early.vs.Control.csv")
write.csv(resOrdered5, "230314.deseq.res5.Late.vs.Control.csv")
write.csv(resOrdered6, "230314.deseq.res6.Mid.vs.Control.csv")
```

Data plotting Data preparation

```{r}

deSeqRes1 <- read.csv("230314.deseq.res1.Early.vs.Late.csv")
deSeqRes2 <- read.csv("230314.deseq.res2.Early.vs.Mid.csv")
deSeqRes3 <- read.csv("230314.deseq.res3.Late.vs.Mid.csv")
deSeqRes4 <- read.csv("230314.deseq.res4.Early.vs.Control.csv")
deSeqRes5 <- read.csv("230314.deseq.res5.Late.vs.Control.csv")
deSeqRes6 <- read.csv("230314.deseq.res6.Mid.vs.Control.csv")

#adding a col to resOrdered calling it sig, and conditioning it to "yes" if padj is 
#less than 0.05, otherwise "no"
deSeqRes1$sig <- ifelse(deSeqRes1$padj <= 0.05, "yes", "no")
deSeqRes2$sig <- ifelse(deSeqRes2$padj <= 0.05, "yes", "no")
deSeqRes3$sig <- ifelse(deSeqRes3$padj <= 0.05, "yes", "no")
deSeqRes4$sig <- ifelse(deSeqRes4$padj <= 0.05, "yes", "no")
deSeqRes5$sig <- ifelse(deSeqRes5$padj <= 0.05, "yes", "no")
deSeqRes6$sig <- ifelse(deSeqRes6$padj <= 0.05, "yes", "no")

#omitting the "NA"
deSeqRes1 <- na.omit(deSeqRes1)
deSeqRes2 <- na.omit(deSeqRes2)
deSeqRes3 <- na.omit(deSeqRes3)
deSeqRes4 <- na.omit(deSeqRes4)
deSeqRes5 <- na.omit(deSeqRes5)
deSeqRes6 <- na.omit(deSeqRes6)

```

```{r}


make_rownames <- function(data) {
  # Extract the first column as row names
  row_names <- make.names(data[, 1])
  
  # Remove the first column from the data
  data <- data[, -1]
  
  # Set the row names
  rownames(data) <- row_names
  
  return(data)
}


Res1 <- make_rownames(deSeqRes1)
Res2 <- make_rownames(deSeqRes2)
Res3 <- make_rownames(deSeqRes3)
Res4 <- make_rownames(deSeqRes4)
Res5 <- make_rownames(deSeqRes5)
Res6 <- make_rownames(deSeqRes6)



```

```{r}

library(ggVennDiagram)
library(dplyr)
library(yulab.utils)
library(sf)
library(ggplot2)
library(plotly)


get_genes <- function(dataframe) {
  return(rownames(dataframe[dataframe$log2FoldChange >= 1.5 & dataframe$padj < 0.05, , drop = FALSE]))
}


set1 <- get_genes(Res1)
set2 <- get_genes(Res2)
set3 <- get_genes(Res3)

set4 <- get_genes(Res4)
set5 <- get_genes(Res5)
set6 <- get_genes(Res6)

unique_to_set4 <- setdiff(set4, union(set5, set6))
write.csv(data.frame(Gene = unique_to_set4), file = "unique_to_set4.csv", row.names = FALSE)


```

```{r}

gene_list2 <- list("Early vs Control" = set4,
                  "Mid vs Control" = set6,
                  "Late vs Control" = set5)


venn <- Venn(gene_list2)
data <- process_data(venn)

items <- venn_region(data) %>%
  rowwise() %>%
  mutate(
    text = yulab.utils::str_wrap(paste0(.data$item, collapse = " "), width = 40)
  ) %>%
  sf::st_as_sf()

label_coord = sf::st_centroid(items$geometry) %>% sf::st_coordinates()

p <- ggplot(items) +
  geom_sf(aes(fill = count)) +
  geom_sf_text(aes(label = name),
               data = data@setLabel,
               inherit.aes = FALSE,
               size = 8) +
  geom_text(
    aes(label = count, text = text),
    x = label_coord[, 1],
    y = label_coord[, 2],
    show.legend = FALSE,
    size = 12
  ) +
  scale_x_continuous(expand = expansion(mult = .4))+
  theme_void() +
  scale_fill_distiller(palette = "Oranges", direction = 1)+
  theme(legend.position = c(0.85, 0.25),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 20)
        )


print(p)
ggsave("venn_sample_vs_control.png", p, width = 12, height = 8, units = "in", dpi = 300)



#early_vs_control_genes <- venn_results[["1"]]$label

# Display the extracted gene names
#print(early_vs_control_genes)





```


```{r}

gene_list1 <- list("Early vs Late" = set1,
                  "Early vs Mid" = set2,
                   "Late vs Mid" = set3)

venn1 <- Venn(gene_list1)
data1 <- process_data(venn1)

items <- venn_region(data1) %>%
  rowwise() %>%
  mutate(
    text = yulab.utils::str_wrap(paste0(.data$item, collapse = " "), width = 40)
  ) %>%
  sf::st_as_sf()

label_coord = sf::st_centroid(items$geometry) %>% sf::st_coordinates()

p <- ggplot(items) +
  geom_sf(aes(fill = count)) +
  geom_sf_text(aes(label = name),
               data = data1@setLabel,
               inherit.aes = FALSE,
               size = 8) +
  geom_text(
    aes(label = count, text = text),
    x = label_coord[, 1],
    y = label_coord[, 2],
    show.legend = FALSE,
    size = 12
  ) +
  scale_x_continuous(expand = expansion(mult = .4))+
  theme_void() +
  scale_fill_distiller(palette = "Greens", direction = 1)+
  theme(legend.position = c(0.85, 0.25),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 20)
        )


print(p)
ggsave("venn2_sample_vs_sample.png", p, width = 12, height = 8, units = "in", dpi = 300)




```


venn diagrams

```{r}

#venn.diagram

library(VennDiagram)


get_genes_names <- function(res) {
  return(rownames(res[which(res$padj < 0.05 & abs(res$log2FoldChange) >= 1.5), ]))
}

venn_res1 <- get_genes_names(Res1)
venn_res2 <- get_genes_names(Res1)
venn_res3 <- get_genes_names(Res1)
venn_res4 <- get_genes_names(Res1)
venn_res5 <- get_genes_names(Res1)
venn_res6 <- get_genes_names(Res1)





color_scheme1 <- c("#FF000080", "#00FF0080", "#0000FF80")
color_scheme2 <- c("#FFA50080", "#FF149380", "#80808080")

par(mar=c(5, 5, 5, 5))

vd1 <- venn.diagram(
    x=list(venn_res1, venn_res2, venn_res3),
    category.names=c("Early vs Late", "Early vs Mid", "Late vs Mid"),
    col=color_scheme1,
    fill=color_scheme1,
    alpha=0.5,
    border=NA,
    lty="blank",
    disable.logging = T,
	  margin = 0.09,
    height = 3000,
  	width = 3000,
	  resolution = 800,
	  cat.default.pos = "outer",
	  cat.dist = c(0.1, 0.1, 0.05),
    filename="231115_venn_1.png"
)


vd2 <- venn.diagram(
    x=list(venn_res4, venn_res5, venn_res6),
    category.names=c("Early vs Control", "Late vs Control", "Mid vs Control"),
    col=color_scheme2,
    fill=color_scheme2,
    alpha=0.5,
    lty="blank",
    disable.logging = T,
  	margin = 0.09,
    height = 3000,
  	width = 3000,
	  resolution = 800,
	  cat.default.pos = "outer",
	  cat.dist = c(0.1, 0.1, 0.05),
    filename="231115_venn_2.png"
)






```

```{r}

# Get the set of genes that are only in Late vs Mid
genes_in_late_mid <- setdiff(venn_res3, intersect(venn_res1, venn_res2))

genes_in_late_mid_only <- setdiff(venn_res3, union(venn_res1, venn_res2))

unique_genes <- setdiff(venn_res3, union(venn_res1, venn_res2))

write.csv(unique_genes, file = "unique_genes.csv", row.names = FALSE)


# Print the list of genes
print(genes_in_late_mid)

```

plotting the basemean and fold change then label pvalue whether it is significant or not

```{r}
resultsNames(ddsDE)

resLFC <- lfcShrink(ddsDE, coef="Type_Early_vs_Control", type="apeglm")
plotMA(resLFC, ylim=c(-5,5))


sigplot <- ggplot(deSeqRes1, aes(x = log10(baseMean), y = log2FoldChange, color = sig, )) +
  ylim(-10, 10) +
  theme(legend.position="none") +
  scale_color_manual(breaks = c("yes", "no"),
                       values=c("#CC0033", "black")) +
  geom_point() 
```

Volcano plots using enhanced volcano package

```{r}
#setting the threshold
pval_threshold <- 0.05
logfc_threshold <- 1.5


## enhanced Volcano

v1 <- EnhancedVolcano(deSeqRes1,
              lab = NA,
                x = 'log2FoldChange',
                y = 'padj',
                xlab = NULL,
                ylab = NULL,
                ylim = c(0, 30),
                xlim = c(-15, 15),
                pCutoff = 0.05,
                FCcutoff = 1.5,
                col=c('black', 'black', 'black', 'red3'),
                pointSize = 2.0,
                #labSize = 4,
                axisLabSize = 12,
                colAlpha = 0.4,
                legendPosition = "none",
                subtitle = "Early vs. Late",
                subtitleLabSize = 12,
                title = NULL,
                caption = NULL,
                gridlines.major = F,
                gridlines.minor = F,
)

v2 <- EnhancedVolcano(deSeqRes2,
                      lab = NA,
                      x = 'log2FoldChange',
                      y = 'padj',
                      xlab = NULL,
                      ylab = NULL,
                      ylim = c(0, 30),
                      xlim = c(-15, 15),
                      pCutoff = 0.05,
                      FCcutoff = 1.5,
                      col=c('black', 'black', 'black', 'red3'),
                      pointSize = 2.0,
                      labSize = 4,
                      axisLabSize = 12,
                      colAlpha = 0.4,
                      legendPosition = "none",
                      subtitle = "Early vs. Mid",
                      subtitleLabSize = 12,
                      title = NULL,
                      caption = NULL,
                      gridlines.major = F,
                      gridlines.minor = F,
)

v3 <- EnhancedVolcano(deSeqRes3,
                      lab = NA,
                      x = 'log2FoldChange',
                      y = 'padj',
                      xlab = NULL,
                      ylab = NULL,
                      ylim = c(0, 30),
                      xlim = c(-15, 15),
                      pCutoff = 0.05,
                      FCcutoff = 1.5,
                      col=c('black', 'black', 'black', 'red3'),
                      pointSize = 2.0,
                      labSize = 4,
                      axisLabSize = 12,
                      colAlpha = 0.4,
                      legendPosition = "none",
                      subtitle = "Late vs. Mid",
                      subtitleLabSize = 12,
                      title = NULL,
                      caption = NULL,
                      gridlines.major = F,
                      gridlines.minor = F,
)

v4 <- EnhancedVolcano(deSeqRes4,
                      lab = NA,
                      x = 'log2FoldChange',
                      y = 'padj',
                      xlab = NULL,
                      ylab = NULL,
                      ylim = c(0, 300),
                      xlim = c(-15, 15),
                      pCutoff = 0.05,
                      FCcutoff = 1.5,
                      col=c('black', 'black', 'black', 'red3'),
                      pointSize = 2.0,
                      labSize = 22,
                      axisLabSize = 12,
                      colAlpha = 0.4,
                      legendPosition = "none",
                      subtitle = "Early vs. Control",
                      subtitleLabSize = 12,
                      title = NULL,
                      caption = NULL,
                      gridlines.major = F,
                      gridlines.minor = F,
)


v5 <- EnhancedVolcano(deSeqRes5,
                      lab = NA,
                      x = 'log2FoldChange',
                      y = 'padj',
                      xlab = NULL,
                      ylab = NULL,
                      ylim = c(0, 300),
                      xlim = c(-15, 15),
                      pCutoff = 0.05,
                      FCcutoff = 1.5,
                      col=c('black', 'black', 'black', 'red3'),
                      pointSize = 2.0,
                      labSize = 22,
                      axisLabSize = 12,
                      colAlpha = 0.4,
                      legendPosition = "none",
                      subtitle = "Late vs. Control",
                      subtitleLabSize = 12,
                      title = NULL,
                      caption = NULL,
                      gridlines.major = F,
                      gridlines.minor = F,
)


v6 <- EnhancedVolcano(deSeqRes6,
                      lab = NA,
                      x = 'log2FoldChange',
                      y = 'padj',
                      xlab = NULL,
                      ylab = NULL,
                      ylim = c(0, 300),
                      xlim = c(-15, 15),
                      pCutoff = 0.05,
                      FCcutoff = 1.5,
                      col=c('black', 'black', 'black', 'red3'),
                      pointSize = 2.0,
                      labSize = 22,
                      axisLabSize = 12,
                      colAlpha = 0.4,
                      legendPosition = "none",
                      subtitle = "Mid vs. Control",
                      subtitleLabSize = 12,
                      title = NULL,
                      caption = NULL,
                      gridlines.major = F,
                      gridlines.minor = F,
)


#combine the volcano plots
volcano6plot <- plot_grid(v1, v2, v3, v4, v6, v5, vjust = 0.1, nrow = 2) +
  theme(plot.margin = unit(c(0.5, 0, 0,0), "cm"))

#create common x and y labels
y.grobV <- textGrob(bquote(~-Log[10] ~ italic(padj)), rot = 90, gp = gpar(col = "black", fontsize = 14))

x.grobV <- textGrob(bquote(~Log[2]~ 'fold change'), gp = gpar(col = "black", fontsize = 14))
                    
                    
#add to plot
#grid.arrange(arrangeGrob(volcano6plot, left = y.grobV, bottom = x.grobV))

combined_plot <- arrangeGrob(volcano6plot, left = y.grobV, bottom = x.grobV)

# Save the plot
ggsave("combined_volcano_plot.png", combined_plot,width = 8, height = 5, dpi = 600)

```

Heatmap, using the complexheatmaps package
Induction phase heatmap figure_1 

```{r}
setwd("F:RNAseq data/5th batch (Motoike) 2024-08-05")

```


```{r}


normCounts <- read.csv("normalized.data.240819.csv", row.names = 1)
info <- read.csv("info_all.csv")
colnames(normCounts) <- info$PN
info3 <- read.csv("info_1231.csv")
sub <- normCounts[,c(4:6, 22:23)]

#colnames(sub) <- info3$PN

# Define the groups and the genes in each group
groups <- list(
  "Serotonin" = c('TPH2', 'HTR1B', 'MAOA', "HTR2A")
)

# Extract the gene names from the groups
group_genes <- unlist(groups)

# Subset the data frame to select rows with matching gene names
subset_counts <- sub[group_genes, , drop = FALSE]
mat <- as.matrix(subset_counts)
mat_scaled <- t(scale(t(mat)))

# Create a data frame with row annotations for grouping
row_annotation_df <- data.frame(
  Group = factor(rep(names(groups), sapply(groups, length)))
)


annot = data.frame(line = c(rep("iNSCs", 3), rep("Diff", 2)),
                   row.names = colnames(info3$code))

anno.colors <- list(line = c("iNSCs" = "grey10", "Diff" = "grey20"))


ha = HeatmapAnnotation(df = annot,name = "Annotation", col = anno.colors, show_annotation_name = F,
                         show_legend = F,
                       annotation_legend_param = list(line = list(title = NULL, labels_gp = gpar(fontsize = 5),
                                                                  labels = c("iNSCs","Diff"))))

split <- factor(info3$Cell, levels=c("iNSCs","Diff"))





# Create the heatmap with row annotations for grouping
hm <- Heatmap(
  mat_scaled,
  name = "z-score",
  #top_annotation = ha,
  heatmap_legend_param = list(
  at = c(-3, 0, 3),                     # Values to show on the legend
  title_position = "lefttop-rot",       # Position of the legend title
  legend_width = unit(0.5, "cm"),         # Width of the legend
  legend_height = unit(1.5, "cm"),      # Height of the legend
  labels_gp = gpar(fontsize = 6),        # Font size of the labels
  title_gp = gpar(fontsize = 8)
  ),
  col = rocket(100),
  cluster_rows = T,
  cluster_columns = F,
  column_dend_height = unit(1, "cm"),
  row_dend_width = unit(1, "cm"),
  border = TRUE,
  show_column_names = T,
  show_row_names = TRUE,
  row_names_gp = gpar(fontsize = 10),
  show_row_dend = F,
  column_names_gp = gpar(fontsize = 10),
  column_title_gp = gpar(fontsize = 12),
  show_column_dend = F,
  show_heatmap_legend = TRUE,
  row_title_rot = 0,
  column_title_rot = 0,
  column_names_rot = 45,
  row_title_gp = gpar(fontsize = 12),
  row_gap = unit(2, "mm"),
  column_gap = unit(2, "mm"),
  column_split = split,
  cluster_column_slices = T,
)


png(file = "240819heatmap_EvsDiff_serotonin.png", width = 3.2, height = 2, units = "in", res = 1200, bg = "transparent")
draw(hm, padding = unit(c(4, 4, 2, 2), "mm"), merge_legend = TRUE)
dev.off()

```






```{r}

normCounts <- read.csv("normalized.data.231214.csv", row.names = 1)   
info <- read.csv("info_all.csv")
colnames(normCounts) <- info$PN

# Define the groups and the genes in each group
groups <- list(
  "Neural stem cells" = c('PAX6', 'SOX2', 'SOX1', 'NES', 'DLL1', 'HES5', 'NOTCH1', 'FABP7'),
  "Differentiated" = c("L1CAM", "MAP2", "TUBB3", "NEFL"),
  "Forebrain" = c('ISL1', 'OTX2', "SFRP1"),
   "Pluripotency" = c('NANOG', 'POU5F1', "LIN28A" ),
  "Midbrain" = c('TH', 'LMX1B', "CLSTN2"),
  "Hindbrain" = c('GBX2', 'PHOX2B', 'HOXB4', 'HOXB2', 'HOXA2', 'PAX3'),
  "Spinal cord" = c('CADPS2', 'HOXB9', 'HOXB8', 'HOXB7', 'HOXB6')
)

# Extract the gene names from the groups
group_genes <- unlist(groups)

# Subset the data frame to select rows with matching gene names
subset_counts <- normCounts[group_genes, , drop = FALSE]
mat <- as.matrix(subset_counts)
mat_scaled <- t(scale(t(mat)))

# Create a data frame with row annotations for grouping
row_annotation_df <- data.frame(
  Group = factor(rep(names(groups), sapply(groups, length)))
)


annot = data.frame(line = c(rep("Early",8), rep("Mid", 4), rep("Late", 6), "Early_Diff", "Late_Diff", rep("Control", 3)),
                   row.names = colnames(info$code))

anno.colors <- list(line = c("Control" = "darkred", "Early" = "gold", "Mid" = "darkcyan", 
                             "Late" = "darkgreen", "Early_Diff" = "orange3", "Late_Diff" = "green3"))


ha = HeatmapAnnotation(df = annot,name = "Annotation", col = anno.colors, show_annotation_name = F,
                         show_legend = T,
                       annotation_legend_param = list(line = list(title = NULL, labels_gp = gpar(fontsize = 12),
                                                                  labels = c("Control","Early","Mid","Late", "Early_Diff", "Late_Diff"), 
                                                                  at = c("Control","Early","Mid","Late", "Early_Diff", "Late_Diff"))))


split <- factor(row_annotation_df$Group, levels=c("Pluripotency","Neural stem cells","Differentiated", "Forebrain","Midbrain","Hindbrain","Spinal cord" ))
split2 <- factor(annot$line, levels=c("Control","Early","Mid","Late"))



# Create the heatmap with row annotations for grouping
hm <- Heatmap(
  mat_scaled,
  name = "z-score",
  top_annotation = ha,
  heatmap_legend_param = list(at = c(-5, 0, 5), title_position = "lefttop-rot"),
  col = rocket(100),
  cluster_rows = T,
  cluster_columns = F,
  column_dend_height = unit(1, "cm"),
  row_dend_width = unit(1, "cm"),
  border = TRUE,
  show_column_names = T,
  show_row_names = TRUE,
  row_names_gp = gpar(fontsize = 14),
  show_row_dend = T,
  column_names_gp = gpar(fontsize = 12),
  column_title_gp = gpar(fontsize = 12),
  show_column_dend = TRUE,
  show_heatmap_legend = TRUE,
  column_title = NULL,
  row_title_rot = 0,
  column_title_rot = 0,
  row_title_gp = gpar(fontsize = 16),
  row_gap = unit(2, "mm"),
  column_gap = unit(2, "mm"),
  row_split = split,
  column_split = split2,
  cluster_row_slices = F, 
  cluster_column_slices = F,
)


png(file = "240502heatmap_E.M.L3.png", width = 9, height = 8, units = "in", res = 300, bg = "transparent")
draw(hm, padding = unit(c(2, 2, 2, 2), "mm"), merge_legend = TRUE)
dev.off()
```

Sub heatmap for the hox genes

```{r}
#heatmap HOX genes


HOX <- read.csv("HOX_genes_normCounts.csv", row.names = 1)
info_hox <- read.csv("info_HOX.csv")

HOX_mat <- as.matrix(HOX)
HOX_mat_scaled  <-  t(scale(t(HOX_mat)))

colnames(HOX_mat_scaled) <- make.names(info_hox$PN)


png(file="230318_heatmap_raster-off_NoSplit_HOXgenes.png", width=5,height=6,units="in",res=1200)

HOX_hm <- Heatmap(HOX_mat_scaled, 
              cluster_rows = F,
              cluster_columns = F,
              heatmap_legend_param = list(at = c(-3, 0, 3)),
              name="Z-score",
              col = rocket(100),
              column_dend_height = unit(1, "cm"),
              row_dend_width = unit(1, "cm"),
              show_row_names = T,
              show_column_names = T,
              column_title = NULL,
              show_row_dend = F,
              row_title = NULL,
              use_raster = F,
              border = T,
            
) 

#plot the heatmap with clear edges and stacked legends
draw(HOX_hm, padding = unit(c(2, 2, 2, 2), "mm"), merge_legend = T)
dev.off()







```

Filtering out the counts for the sigDEGs and making heatmap for them

```{r}
##########################
# sigcounts complex heatmap

#read data with row.names=1
normCounts <- read.csv("normalized.data.230314.csv", row.names = 1)

deSeqRes1 <- read.csv("230314.deseq.res1.Early.vs.Late.csv", row.names = 1)
deSeqRes2 <- read.csv("230314.deseq.res2.Early.vs.Mid.csv", row.names = 1)
deSeqRes3 <- read.csv("230314.deseq.res3.Late.vs.Mid.csv", row.names = 1)
deSeqRes4 <- read.csv("230314.deseq.res4.Early.vs.Control.csv", row.names = 1)
deSeqRes5 <- read.csv("230314.deseq.res5.Late.vs.Control.csv", row.names = 1)
deSeqRes6 <- read.csv("230314.deseq.res6.Mid.vs.Control.csv", row.names = 1)

#filter out only the significant DEGs
signi1 <- subset(deSeqRes1, padj <= 0.05)
signi2 <- subset(deSeqRes2, padj <= 0.05)
signi3 <- subset(deSeqRes3, padj <= 0.05)
signi4 <- subset(deSeqRes4, padj <= 0.05)
signi5 <- subset(deSeqRes5, padj <= 0.05)
signi6 <- subset(deSeqRes6, padj <= 0.05)

#call both data frames then tell on which condition to merg upon
allsig1 <- merge(normCounts, signi1, by = 0)
allsig2 <- merge(normCounts, signi2, by = 0)
allsig3 <- merge(normCounts, signi3, by = 0)
allsig4 <- merge(normCounts, signi4, by = 0)
allsig5 <- merge(normCounts, signi5, by = 0)
allsig6 <- merge(normCounts, signi6, by = 0)


#save only the counts cols
sigcounts1 <- subset(allsig1, select = c(2:9, 14:19))
sigcounts2 <- subset(allsig2, select = c(2:13))
sigcounts3 <- subset(allsig3, select = c(10:13, 14:19))
sigcounts4 <- subset(allsig4, select = c(2:9, 22:24))
sigcounts5 <- subset(allsig5, select = c(14:19, 22:24))
sigcounts6 <- subset(allsig6, select = c(10:13, 22:24))

#adding cols/rows name to the sigcounts

# Subset info to only include the matching Cell_Lines
info_1 <- info[c(1:8, 13:18),]
info_2 <- info[1:12,]
info_3 <- info[9:18,]
info_4 <- info[c(1:8, 21:32),]
info_4 <- subset(info_4, complete.cases(info_4))
info_5 <- info[c(13:18, 21:32),]
info_5 <- subset(info_5, complete.cases(info_5))
info_6 <- info[c(9:12, 21:32),]
info_6 <- subset(info_6, complete.cases(info_6))

# Rename columns of sigcounts1 using matching names
colnames(sigcounts1) <- info_1$PN
colnames(sigcounts2) <- info_2$PN
colnames(sigcounts3) <- info_3$PN
colnames(sigcounts4) <- info_4$PN
colnames(sigcounts5) <- info_5$PN
colnames(sigcounts6) <- info_6$PN

row.names(sigcounts1) <- allsig1$Row.names
row.names(sigcounts2) <- allsig2$Row.names
row.names(sigcounts3) <- allsig3$Row.names
row.names(sigcounts4) <- allsig4$Row.names
row.names(sigcounts5) <- allsig5$Row.names
row.names(sigcounts6) <- allsig6$Row.names


#1
write.csv(sigcounts1, "230315sig.DEGs.Early.vs.Late.countData.csv")
write.csv(signi1, "2230315sig.DEGs.Early.vs.Late.csv")
#2
write.csv(sigcounts2, "230315sig.DEGs.Early.vs.Mid.countData.csv")
write.csv(signi2, "2230315sig.DEGs.Early.vs.Mid.csv")
#3
write.csv(sigcounts3, "230315sig.DEGs.Late.vs.Mid.countData.csv")
write.csv(signi3, "2230315sig.DEGs.Late.vs.Mid.csv")
#4
write.csv(sigcounts4, "230315sig.DEGs.Early.vs.control.countData.csv")
write.csv(signi4, "2230315sig.DEGs.Early.vs.control.csv")
#5
write.csv(sigcounts5, "230315sig.DEGs.Late.vs.control.countData.csv")
write.csv(signi5, "2230315sig.DEGs.Late.vs.control.csv")
#6
write.csv(sigcounts6, "230315sig.DEGs.Mid.vs.control.countData.csv")
write.csv(signi6, "2230315sig.DEGs.Mid.vs.control.csv")
```

sub_anno.colors \<- list(line = c("Early" = "yellow3", "Mid" = "orange", "Late" = "brown", "Control" = "blue3"))

```{r}



#Heatmap of Sigcounts Early vs. Late


mat_1 <- as.matrix(sigcounts1)
mat_scaled_1  <-  t(scale(t(mat_1)))

annot_1 = data.frame(line = c(rep("Early", 8), rep("Late", 6)),
                   row.names = colnames(info_1$code))

anno.colors_1 <- list(line = c("Early" = "yellow3", "Late" = "brown"))


ha_1 = HeatmapAnnotation(df = annot_1, name = "Annotation1", col = anno.colors_1, show_annotation_name = F,
                         show_legend = F,
                       annotation_legend_param = list(line = list(title = NULL, labels_gp = gpar(fontsize = 10))))

png(file="230314_sigCounts_Early_vs._Late_heatmaps.png", width=2,height=3,units="in",res=1200)

hm_1 <- Heatmap(mat_scaled_1, name = "hm1",
              top_annotation = ha_1,
              heatmap_legend_param = list(at = c(-3, 0, 3)),
              col = magma(100),
              cluster_rows = T,
              cluster_columns = F,
              column_dend_height = unit(1, "cm"),
              row_dend_width = unit(1, "cm"),
              show_row_names = F,
              column_split = annot_1$line,
              border = T,
              row_km = 2,
              show_column_names = T,
              show_row_dend = F,
              column_title = "Early vs. Late",
              row_title = NULL,
              column_names_gp =  gpar(fontsize = 8),
              column_title_gp = gpar(fontsize = 14),
              use_raster = F,
              show_column_dend = FALSE, 
              show_heatmap_legend = F,
) 

draw(hm_1)
dev.off()

#Heatmap of Sigcounts Early vs. Mid

mat_2 <- as.matrix(sigcounts2)
mat_scaled_2  <-  t(scale(t(mat_2)))

annot_2 = data.frame(line = c(rep("Early", 8), rep("Mid", 4)),
                   row.names = colnames(info_2$code))

anno.colors_2 <- list(line = c("Early" = "yellow3", "Mid" = "orange"))


ha_2 = HeatmapAnnotation(df = annot_2, name = "Annotation2", col = anno.colors_2, show_annotation_name = F,
                         show_legend = F,
                       annotation_legend_param = list(line = list(title = NULL, labels_gp = gpar(fontsize = 10))))

png(file="230314_sigCounts_Early_vs._Mid_heatmaps.png", width=2,height=3,units="in",res=1200)

hm_2 <- Heatmap(mat_scaled_2, name = "hm2",
              top_annotation = ha_2,
              heatmap_legend_param = list(at = c(-3, 0, 3)),
              col = magma(100),
              cluster_rows = T,
              cluster_columns = F,
              column_dend_height = unit(1, "cm"),
              row_dend_width = unit(1, "cm"),
              show_row_names = F,
              column_split = annot_2$line,
              border = T,
              row_km = 2,
              show_column_names = T,
              show_row_dend = F,
              column_title = "Early vs. Mid",
              row_title = NULL,
              column_names_gp =  gpar(fontsize = 8),
              column_title_gp = gpar(fontsize = 14),
              use_raster = F,
              show_column_dend = FALSE, 
              show_heatmap_legend = F,
) 

draw(hm_2)
dev.off()

#Heatmap of Sigcounts Late vs. Mid

mat_3 <- as.matrix(sigcounts3)
mat_scaled_3  <-  t(scale(t(mat_3)))

annot_3 = data.frame(line = c(rep("Mid", 4), rep("Late", 6)),
                   row.names = colnames(info_3$code))

anno.colors_3 <- list(line = c("Mid" = "orange", "Late" = "brown"))


ha_3 = HeatmapAnnotation(df = annot_3,name = "Annotation3", col = anno.colors_3, show_annotation_name = F,
                         show_legend = F,
                       annotation_legend_param = list(line = list(title = NULL, labels_gp = gpar(fontsize = 10))))

png(file="230314_sigCounts_Late_vs._Mid_heatmaps.png", width=2,height=3,units="in",res=1200)

hm_3 <- Heatmap(mat_scaled_3, name = "hm3",
              top_annotation = ha_3,
              heatmap_legend_param = list(at = c(-3, 0, 3)),
              col = magma(100),
              cluster_rows = T,
              cluster_columns = F,
              column_dend_height = unit(1, "cm"),
              row_dend_width = unit(1, "cm"),
              show_row_names = F,
              column_split = annot_3$line,
              border = T,
              row_km = 2,
              show_column_names = T,
              show_row_dend = F,
              column_title = "Late vs. Mid",
              row_title = NULL,
              column_names_gp =  gpar(fontsize = 8),
              column_title_gp = gpar(fontsize = 14),
              use_raster = F,
              show_column_dend = FALSE, 
              show_heatmap_legend = F,
) 

draw(hm_3)
dev.off()

#Heatmap of Sigcounts Early vs. control

mat_4 <- as.matrix(sigcounts4)
mat_scaled_4  <-  t(scale(t(mat_4)))

annot_4 = data.frame(line = c(rep("Early", 8), rep("Control", 3)),
                   row.names = colnames(info_4$code))

anno.colors_4 <- list(line = c("Early" = "yellow3", "Control" = "blue3"))


ha_4 = HeatmapAnnotation(df = annot_4,name = "Annotation4", col = anno.colors_4, show_annotation_name = F,
                         show_legend = F,
                       annotation_legend_param = list(line = list(title = NULL, labels_gp = gpar(fontsize = 10))))

png(file="230314_sigCounts_Early_vs._control_heatmaps.png", width=2,height=3,units="in",res=1200)

hm_4 <- Heatmap(mat_scaled_4, name = "hm4",
              top_annotation = ha_4,
              heatmap_legend_param = list(at = c(-3, 0, 3)),
              col = magma(100),
              cluster_rows = T,
              cluster_columns = F,
              column_dend_height = unit(1, "cm"),
              row_dend_width = unit(1, "cm"),
              show_row_names = F,
              column_split = annot_4$line,
              border = T,
              row_km = 2,
              show_column_names = T,
              show_row_dend = F,
              column_title = "Early vs. control",
              row_title = NULL,
              column_names_gp =  gpar(fontsize = 8),
              column_title_gp = gpar(fontsize = 14),
              use_raster = F,
              show_column_dend = FALSE, 
              show_heatmap_legend = F,
) 

draw(hm_4)
dev.off()

#Heatmap of Sigcounts Late vs. control

mat_5 <- as.matrix(sigcounts5)
mat_scaled_5  <-  t(scale(t(mat_5)))

annot_5 = data.frame(line = c(rep("Late", 6), rep("Control", 3)),
                   row.names = colnames(info_5$code))

anno.colors_5 <- list(line = c("Late" = "brown", "Control" = "blue3"))


ha_5 = HeatmapAnnotation(df = annot_5,name = "Annotation5", col = anno.colors_5, show_annotation_name = F,
                         show_legend = F,
                       annotation_legend_param = list(line = list(title = NULL, labels_gp = gpar(fontsize = 10))))

png(file="230314_sigCounts_Late_vs._control_heatmaps.png", width=2,height=3,units="in",res=1200)

hm_5 <- Heatmap(mat_scaled_5, name = "hm5",
              top_annotation = ha_5,
              heatmap_legend_param = list(at = c(-3, 0, 3)),
              col = magma(100),
              cluster_rows = T,
              cluster_columns = F,
              column_dend_height = unit(1, "cm"),
              row_dend_width = unit(1, "cm"),
              show_row_names = F,
              column_split = annot_5$line,
              border = T,
              row_km = 2,
              show_column_names = T,
              show_row_dend = F,
              column_title = "Late vs. control",
              row_title = NULL,
              column_names_gp =  gpar(fontsize = 8),
              column_title_gp = gpar(fontsize = 14),
              use_raster = F,
              show_column_dend = FALSE, 
              show_heatmap_legend = F,
) 

draw(hm_5)
dev.off()

#Heatmap of Sigcounts Mid vs. control

mat_6 <- as.matrix(sigcounts6)
mat_scaled_6  <-  t(scale(t(mat_6)))

annot_6 = data.frame(line = c(rep("Mid", 4), rep("Control", 3)),
                   row.names = colnames(info_6$code))

anno.colors_6 <- list(line = c("Mid" = "orange", "Control" = "blue3"))


ha_6 = HeatmapAnnotation(df = annot_6,name = "Annotation6", col = anno.colors_6, show_annotation_name = F,
                         show_legend = F,
                       annotation_legend_param = list(line = list(title = NULL, labels_gp = gpar(fontsize = 10))))

png(file="230314_sigCounts_Mid_vs._control_heatmaps.png", width=2,height=3,units="in",res=1200)

hm_6 <- Heatmap(mat_scaled_6, name = "hm6",
              top_annotation = ha_6,
              heatmap_legend_param = list(at = c(-3, 0, 3)),
              col = magma(100),
              cluster_rows = T,
              cluster_columns = F,
              column_dend_height = unit(1, "cm"),
              row_dend_width = unit(1, "cm"),
              show_row_names = F,
              column_split = annot_6$line,
              border = T,
              row_km = 2,
              show_column_names = T,
              show_row_dend = F,
              column_title = "Mid vs. control",
              row_title = NULL,
              column_names_gp =  gpar(fontsize = 8),
              column_title_gp = gpar(fontsize = 14),
              use_raster = F,
              show_column_dend = FALSE, 
              show_heatmap_legend = F,
) 

draw(hm_6)
dev.off()



```

correlation heatmap

```{r}
##cor heatmap
cor_mat = cor(normCounts)

corhm <- Heatmap(cor(t(cor_mat)),
                 cluster_rows = F,
                 heatmap_legend_param = list(at = c(-1, 0, 1), title = NULL),
                 cluster_columns = F,
                 col = colorRamp2(c(-1, 0, 1), c("green4", "white", "red4")), 
                 show_row_names = T, 
                 show_column_names = F, 
                 row_dend_side = "right", 
                 show_column_dend = F, 
                 column_dend_side = "bottom",
                 column_dend_height = unit(5, "mm"),
                 row_dend_width = unit(5, "mm"),
                 column_title = "Pairwise correlation between samples",
                 column_title_gp = gpar(fontsize = 16)
                 )

png(file = "240502_cor_heatmap.png", width = 5, height = 4, units = "in", res = 300, bg = "transparent")
draw(corhm, padding = unit(c(2, 2, 2, 2), "mm"))
dev.off()

```

```{r}
setwd("C:/Users/zaici/Desktop/new iNSCs data analysis RNAseq 220228 comparing each 2 conditions/230314 analysis final v0.1/Enrichr")
up1 <- read.csv("e_vs_c_up.csv", row.names = 1)
down1 <- read.csv("e_vs_c_down.csv", row.names = 1)


ggplot() +
  geom_bar(data = up1, aes(x = row.names(up1), y = up1$log2FoldChange), stat = 'identity', fill = 'blue') +
  geom_bar(data = down1, aes(x = row.names(down1), y = down1$log2FoldChange), stat = 'identity', fill = 'red') +
  ggtitle('Bar Plot with Secondary Axis') +
  scale_x_discrete(position = 'top') +
  coord_flip() +
  theme_classic()




```
